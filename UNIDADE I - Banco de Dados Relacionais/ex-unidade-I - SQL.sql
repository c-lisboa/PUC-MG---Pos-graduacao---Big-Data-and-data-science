/***Criado por: Cássio Reis <cassio.reis@engenharia.ufjf.br> ***/
--CREATE DATABASE PUC_MINAS_EX01
--USE PUC_MINAS_EX01
--CRIANDO A TABELA CLIENTE


 IF OBJECT_ID('CLIENTE', 'U') IS NOT NULL 
  DROP TABLE CLIENTE;

CREATE TABLE CLIENTE (
	CODCLIENTE INT NOT NULL, 
	NOME VARCHAR(50) NOT NULL,
	ENDERECO VARCHAR (50)  NULL,
	BAIRRO VARCHAR (20) NULL,
	CIDADE VARCHAR(50) NULL, 
	ESTADO CHAR (2),
	PRIMARY KEY (CODCLIENTE)

)

INSERT INTO CLIENTE (CODCLIENTE,NOME,ENDERECO,BAIRRO,CIDADE,ESTADO) VALUES 
(10 , 'CASSIO' , 'RUA A', 'CENTRO','JUIZ DE FORA','MG'),
(20 ,'CASSIA', 'RUA F', 'LAPA','RIO DE JANEIRO','RJ'),
(30 ,'SANDRA', 'RUA E', 'CENTRO','RIO DE JANEIRO','RJ'),
(40 ,'DANIEL', 'RUA D', 'ITAIM','SÃO PAULO','SP'),
(50 ,'REIS', 'RUA C', 'CACHOEIRA','ENTRE RIOS DE MINAS','SP'),
(60 ,'TESTE1', 'RUA A', 'CENTRO','RIO DE JANEIRO','RJ'),
(70 ,'TESTE2', 'RUA B', 'BAUXITA','OURO PRETO','MG')



/***
	*********************
	    TABELA PRECO
	*********************
*/

IF OBJECT_ID('PRECO', 'U') IS NOT NULL 
  DROP TABLE PRECO;
--CRIANDO A TABELA PRECO
CREATE TABLE PRECO (
	COR CHAR(2) NOT NULL,
	VALOR DECIMAL(10,2) NOT NULL,

	PRIMARY KEY	(COR)
)
INSERT INTO PRECO (COR,VALOR) VALUES
('YE',10.00),
('RE',10.00),
('GR',10.00),
('BL',10.00),
('WH',10.00)


/***
	*********************
	    TABELA GENERO
	*********************
*/
IF OBJECT_ID('GENERO', 'U') IS NOT NULL  DROP TABLE GENERO;
CREATE TABLE GENERO (
	CODGENERO NUMERIC(3) NOT NULL,
	DESCRICAO VARCHAR(20) NOT NULL,

	PRIMARY KEY (CODGENERO)
)	

INSERT INTO GENERO (CODGENERO,DESCRICAO) VALUES 
(1, 'Comedia'),
(2, 'Terror'),
(3, 'Drama'),
(4, 'Romance'),
(5, 'Suspense'),
(6, 'Crime')



/***
	*********************
	    TABELA FILME
	*********************
*/
IF OBJECT_ID('FILME', 'U') IS NOT NULL   DROP TABLE FILME;
CREATE TABLE FILME(
	CODFILME INTEGER NOT NULL,
	NOME VARCHAR(50) NOT NULL,
	FK_COR CHAR(2) NOT NULL,
	STATUS CHAR(1) NOT NULL,
	FK_CODGENERO NUMERIC(3) NOT NULL

	PRIMARY KEY (CODFILME),
	FOREIGN KEY (FK_COR) REFERENCES PRECO(COR),
	FOREIGN KEY (FK_CODGENERO) REFERENCES GENERO(CODGENERO)
)

INSERT INTO FILME (CODFILME,NOME,FK_COR, STATUS,FK_CODGENERO) VALUES
(1,'Filme 1','GR','D',5),
(2,'Filme 10','GR','N',2),
(3,'Filme 11','YE','D',3),
(4,'Filme 12','GR','D',5),
(5,'Filme 13','GR','D',1),
(7,'Filme 14','BL','D',1),
(8,'Filme 15','WH','N',4),
(9,'Filme 16','RE','D',4),
(10,'Filme 21','RE','N',4),
(11,'Filme 23','GR','D',5),
(12,'Filme 25','YE','D',3),
(13,'Filme 289','RE','D',2),
(14,'Filme 26','GR','D',2),
(15,'Filme 29','BL','N',2),
(16,'Filme 20','WH','N',1),
(17,'Filme 52','RE','N',3),
(18,'Filme 62','WH','D',5)



/***
	*********************
	    TABELA LOCACAO
	*********************
*/
IF OBJECT_ID('LOCACAO', 'U') IS NOT NULL   DROP TABLE LOCACAO;
CREATE TABLE LOCACAO (
	FK_CODCLIENTE INTEGER NOT NULL,
	DATA DATE NOT NULL,
	FK_CODFILME INTEGER NOT NULL,
	DATADEVOLUCAO DATE NULL,

	PRIMARY KEY(FK_CODCLIENTE,DATA,FK_CODFILME),
	FOREIGN KEY (FK_CODCLIENTE) REFERENCES CLIENTE(CODCLIENTE),
	FOREIGN KEY (FK_CODFILME) REFERENCES FILME(CODFILME)
)

INSERT INTO LOCACAO (FK_CODCLIENTE,DATA,FK_CODFILME,DATADEVOLUCAO) VALUES
(40,'2019-03-12',15,'2019-03-28'),
(20,'2020-07-15',1,'2020-03-28'),
(10,'2020-06-13',2,'2019-11-28'),
(30,'2020-03-21',3,'2020-02-28'),
(50,'2020-01-26',5,'2020-03-28'),
(20,'2020-01-21',4,'2020-03-21'),
(50,'2020-04-09',7,'2020-03-22'),
(60,'2020-02-04',8,'2020-02-28'),
(20,'2020-03-01',8,'2020-01-28'),
(30,'2018-06-13',9,'2020-03-28'),
(40,'2020-03-15',1,'2020-01-28'),
(40,'2018-03-12',3,'2020-06-28')




/*1- Consulta para retornar os filmes disponíveis*/
SELECT F.NOME,G.DESCRICAO FROM FILME F
RIGHT JOIN GENERO G ON G.CODGENERO=F.FK_CODGENERO 
WHERE F.STATUS='D'


/*2- Consulta para exibir o nome dos filmes, codigo e a data de locação*/
SELECT F.NOME, F.CODFILME, FORMAT(L.DATA,'dd/M/yyyy') AS DATA_LOCACAO FROM FILME F
RIGHT JOIN LOCACAO L ON L.FK_CODFILME = F.CODFILME
WHERE F.STATUS = 'N'


/*3- Exibir o código, nome e preço dos filmes de Terror  */
SELECT F.CODFILME,F.NOME, P.VALOR, P.COR, G.DESCRICAO FROM FILME F
RIGHT JOIN GENERO G ON G.CODGENERO = F.FK_CODGENERO
RIGHT JOIN PRECO P ON P.COR = F.FK_COR  
WHERE G.DESCRICAO='Terror'


/*4 - Exibir o código e nome dos filmes de comédia alugadas por clientes do Rio de Janeiro. Exibir também o nome e código desses clientes. */
SELECT F.CODFILME, F.NOME,C.NOME,C.CODCLIENTE FROM FILME F
LEFT JOIN LOCACAO L ON L.FK_CODFILME = F.CODFILME
INNER JOIN CLIENTE C ON C.CODCLIENTE = L.FK_CODCLIENTE
WHERE C.CIDADE = 'Rio de Janeiro'


/*5 - Exibir o código e nome dos filmes que possuem a mesma cor do filme 16.*/
SELECT F.CODFILME,F.NOME,F.FK_COR FROM FILME F
JOIN PRECO P ON P.COR = F.FK_COR
WHERE F.FK_COR =(SELECT F.FK_COR FROM FILME F WHERE F.CODFILME=16) 


/*6 - Exibir o código e nome dos clientes que moram no mesmo estado dos clientes que alugaram filme no mês de marco. */
SELECT C.CODCLIENTE,C.NOME FROM CLIENTE C
RIGHT JOIN LOCACAO L ON L.FK_CODCLIENTE = C.CODCLIENTE
WHERE  L.DATA IN (SELECT DATA FROM LOCACAO L WHERE MONTH(L.DATA)=3)


/*7 - Exibir o código e nome dos clientes que realizaram mais locações do que o cliente de código 30.*/
DECLARE @LOCACOES INT
SELECT @LOCACOES = (SELECT COUNT(*) FROM LOCACAO L WHERE L.FK_CODCLIENTE =30)
SELECT * FROM (
	SELECT C.NOME,L.FK_CODCLIENTE,COUNT(*) AS QTDLOCACOES FROM CLIENTE C
	RIGHT JOIN LOCACAO L ON L.FK_CODCLIENTE = C.CODCLIENTE
	GROUP BY C.NOME,L.FK_CODCLIENTE	
	) D 
	WHERE D.QTDLOCACOES > @LOCACOES

/*8 - Exibir  o  código  e  nome  dos  filmes  que  possuem  mesma  cor  que  os filmes de Suspense.*/
SELECT F.CODFILME,F.NOME FROM FILME F
WHERE F.FK_COR  IN
			(
			SELECT DISTINCT F.FK_COR FROM FILME F
			RIGHT JOIN GENERO G ON G.CODGENERO=F.FK_CODGENERO
			WHERE G.DESCRICAO = 'Suspense'			
			)

